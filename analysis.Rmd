---
title: "analysis_script.Rmd"
author: "DS421 Team"
date: "March 9, 2020"
output: html_document
---
Install Packages
```{r}
library(tidyverse)
source('scripts/adams_theme.R') #for ggplot2
```


Import data
```{r}
df <- read_csv('data/FireDataKlamath1994.csv', col_types = cols(clusterID = col_factor()))
```

clean data
```{r}
df <- df %>%
  select(-.geo) %>%
  filter(FIRE_YEAR == 1994) %>%
  rename(pixelID = 'system:index')
```


Creating a landcover data frame
```{r}
landcover <- c("NLCD1992","NLCD2004", "NLCD2011", "NLCD2016")
df_lc <- df %>%
  select(pixelID, clusterID, NLCD1992, NLCD2004, NLCD2011, NLCD2016) %>%
  gather(landcover, key = "year_string", value = "landcover_code") %>%
  mutate(land_cover_name = case_when(
    (landcover_code == 71) ~ "grass_herb",
    (landcover_code == 51) ~ "shrub",
    (landcover_code == 42) ~ "evergreen_forest",
    (landcover_code == 43) ~ "mixed forest",
    (landcover_code == 31) ~ "barren_land",
    (landcover_code == 23) ~ "developed",
    (landcover_code == 41) ~ "deciduous_forest",
    (landcover_code == 11) ~ "open_water",
    (landcover_code == 81) ~ "pasture_hay",
    (landcover_code == 33) ~ "transitional_barren",
    (landcover_code == 52) ~ "shrub",
    (landcover_code == 21) ~ "developed",
    (landcover_code == 95) ~ "emergent_herb_wetlands",
    (landcover_code == 90) ~ "woody_wetlands",
    (landcover_code == 22) ~ "developed"
  )) %>%
  mutate(year = as.numeric(gsub("NLCD", "", year_string))) %>%
  arrange(clusterID)

df_lc
```


Creating an NBR dataframe
```{r}
years <- as.character(1985:2017)
df_nbr <- df %>%
  select(pixelID, clusterID, years) %>%
  gather(years, key = "year_string", value = "NBR") %>%
  mutate(year = as.numeric(gsub("NLCD", "", year_string))) %>%
  mutate_at(.vars = "year", .funs = as.numeric) %>%
  arrange(clusterID)

df_nbr
```


Creating a FACTS df
```{r}
factsFields <- paste0("facts",1994:2018)
df_facts <- df %>%
  select(pixelID, clusterID, factsFields) %>%
  gather(factsFields, key = "year_string", value = "factsTreatment") %>%
  mutate(year = as.numeric(gsub("facts", "", year_string))) %>%
  arrange(clusterID)

df_facts
```


Merging dfs together
```{r}
#mering dfs together
df <- df %>% select(pixelID, clusterID, FIRE_YEAR, FireID, aspect, burnSev, distance, eastness, elevation, northness, slope) %>%
  left_join(df_nbr, by = c("pixelID","clusterID")) %>%
  left_join(df_lc,c("pixelID","clusterID","year")) %>%
  left_join(df_facts,c("pixelID","clusterID","year"))

#creating pre-fire NBR values for each pixel
pre_fire_nbr <- df %>% 
  filter(year %in% 1988:1993) %>%
  group_by(pixelID) %>%
  summarise(preFireNBR = mean(NBR))

#adding the pre-fire NBR values to the df
df <- df %>%
  left_join(pre_fire_nbr) %>%
  mutate(pct_nbr_recovery = NBR / preFireNBR)
```


Showing the distribution of NBR values for forest
```{r}
df %>%
  drop_na(land_cover_name) %>%
  filter(landcover_code %in% 41:43) %>%
  ggplot(aes(NBR)) +
  geom_histogram()
```

Showing the distribution of NBR values for shrubland
```{r}
df %>%
  drop_na(land_cover_name) %>%
  filter(landcover_code %in% 51:52) %>%
  ggplot(aes(NBR)) +
  geom_histogram()
```


plot patch-level NBR through time for a random sample of patches
```{r}
patches <- sample(unique(df$clusterID),100)

df %>%
  group_by(FireID, clusterID, year) %>%
  summarise_if(is.numeric,mean) %>%
  filter(clusterID %in% patches) %>%
  ggplot(aes(year,NBR,color = clusterID)) +
  geom_line() +
  adams_theme +
  theme(legend.position = "none")
```


Calculating the percent NBR recovery for each patch
```{r}
#patches <- sample(unique(df$clusterID),10)
df %>%
  group_by(clusterID, year) %>%
  summarise_if(is.numeric,mean) %>%
  filter(clusterID %in% patches) %>%
  ggplot(aes(year,pct_nbr_recovery,color = clusterID)) +
  geom_line() +
  adams_theme +
  theme(legend.position = "none")
```



Histogram of percent recovery in 2000 (6 years after fire)
```{r}
df %>%
  group_by(pixelID, year) %>%
  summarise_if(is.numeric,mean) %>%
  filter(year == 2000) %>%
  ggplot(aes(pct_nbr_recovery)) +
  geom_histogram() +
  xlim(c(0,2.5))
```



Histogram of percent recovery in 2017 (23 years after fire)
```{r}
df %>%
  group_by(pixelID, year) %>%
  summarise_if(is.numeric,mean) %>%
  filter(year == 2017) %>%
  ggplot(aes(pct_nbr_recovery)) +
  geom_histogram() +
  xlim(c(0,2.5))
```


Creating variables showing the percent NBR recovery in 92,97,2017
```{r}
df <- df %>%
  filter(pct_nbr_recovery >= -10)

pctNBRrec2017 <- df %>%
  filter(year == 2017) %>%
  select(pixelID, pct_nbr_recovery) %>%
  rename(pct_nbr_recovery_2017 = pct_nbr_recovery)

pctNBRrec1997 <- df %>%
  filter(year == 1997) %>%
  select(pixelID, pct_nbr_recovery) %>%
  rename(pct_nbr_recovery_1997 = pct_nbr_recovery)

pctNBRrec1992 <- df %>%
  filter(year == 1992) %>%
  select(pixelID, pct_nbr_recovery) %>%
  rename(pct_nbr_recovery_1992 = pct_nbr_recovery)

df <- df %>%
  left_join(pctNBRrec2017) %>%
  left_join(pctNBRrec1997) %>%
  left_join(pctNBRrec1992)
```



Showing the perecent NBR recovery by burn severity class (3 years after fire)
```{r}
df %>%
  ggplot(aes(factor(burnSev), pct_nbr_recovery_1997)) +
  geom_boxplot() +
  ylim(c(0.2,1.5))
```



Showing the perecent NBR recovery by burn severity class (23 years after fire)
```{r}
df %>%
  ggplot(aes(factor(burnSev), pct_nbr_recovery_2017)) +
  geom_boxplot() +
  ylim(c(0.2,1.5))
```



Showing the relationship between distance (to the edge of a medium / high severity burned area) and % NBR recovery in 2017 (26 years after fire)
```{r}
df %>%
  #filter(burnSev == 3) %>%
  ggplot(aes(distance, pct_nbr_recovery_2017)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  xlim(c(0,1000))
```


plot % tree cover over time for a random sample of clusters
```{r}
#create data frame of the change in forest cover for each cluster
#patches <- sample(unique(df$clusterID),5)

df %>%
  drop_na(land_cover_name) %>%
  group_by(clusterID,year) %>%
  summarise(pct_tree = sum(landcover_code %in% 41:43) / length(landcover_code)) %>%
  filter(clusterID %in% patches) %>%
  ggplot(aes(year,pct_tree,color = clusterID)) +
  geom_point() +
  geom_line() +
  adams_theme +
  theme(legend.position = "none")
```




```{r}

summary(lm(data = df, formula = pct_nbr_recovery_2017 ~ slope + elevation + northness + burnSev + distance))

summary(lm(data = df, formula = pct_nbr_recovery_1997 ~ slope + elevation + northness + burnSev + distance))

summary(lm(data = df, formula = pct_nbr_recovery_1992 ~ slope + elevation + northness + burnSev + distance))

```







